name: per-yaml-or-all-on-tf
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    paths:
      - 'dev/**' 
      

jobs:
  diff:
    runs-on: ubuntu-latest
    outputs:
      yaml_changed_json: ${{ steps.prepare.outputs.yaml_changed_json }}
      yaml_changed_count: ${{ steps.prepare.outputs.yaml_changed_count }}
      tf_changed: ${{ steps.prepare.outputs.tf_changed }}
      yaml_all_json: ${{ steps.prepare.outputs.yaml_all_json }}
      yaml_all_count: ${{ steps.prepare.outputs.yaml_all_count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head SHAs
        id: shas
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "BASE=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.sha }}"        >> "$GITHUB_OUTPUT"
          fi

      - name: List changed files
        run: |
          git diff --name-only ${{ steps.shas.outputs.BASE }} ${{ steps.shas.outputs.HEAD }} > changed.txt
          cat changed.txt || true

      - name: Prepare outputs (yaml_changed / tf_changed / yaml_all)
        id: prepare
        run: |
          set -euo pipefail

          # Changed YAML (under folder)
          yaml_changed_json=$(
            sed -E 's/^[[:space:]]+|[[:space:]]+$//g' changed.txt \
            | awk 'NF' \
            | grep -E '\.(ya?ml)$' || true \
            | jq -R -s -c 'split("\n")|map(select(length>0))'
          )
          [ -z "$yaml_changed_json" ] && yaml_changed_json='[]'

          # Did any .tf change (under folder)?
          tf_changed=false
          if grep -qE '\.tf$' changed.txt; then tf_changed=true; fi

          # All YAML files currently tracked in the folder (for the "run again" case)
          FOLDER='configs'   # <--- same folder as above
          yaml_all_json=$(
            git ls-files -- "$FOLDER/**/*.yaml" "$FOLDER/**/*.yml" 2>/dev/null \
            | jq -R -s -c 'split("\n")|map(select(length>0))'
          )
          [ -z "$yaml_all_json" ] && yaml_all_json='[]'

          # Write outputs (use heredocs for JSON)
          echo "yaml_changed_count=$(echo "$yaml_changed_json" | jq 'length')" >> "$GITHUB_OUTPUT"
          echo "yaml_all_count=$(echo "$yaml_all_json" | jq 'length')"         >> "$GITHUB_OUTPUT"
          echo "tf_changed=$tf_changed"                                        >> "$GITHUB_OUTPUT"

          {
            echo "yaml_changed_json<<EOF"
            echo "$yaml_changed_json"
            echo "EOF"
            echo "yaml_all_json<<EOF"
            echo "$yaml_all_json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  # 1) Normal run: once per CHANGED YAML
  per_changed_yaml:
    needs: diff
    if: needs.diff.outputs.yaml_changed_count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.yaml_changed_json) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Process changed YAML
        id: parse
        run: |
          echo "Changed YAML: ${{ matrix.file }}"
          account_id=$(yq '.account_id' "${{ matrix.file }}" || true)
          echo "account_id=$account_id" >> "$GITHUB_OUTPUT"
      - name: Use account_id
        run: echo "Account ID -  ${{ steps.parse.outputs.account_id }}"

  # 2) Extra run when ANY .tf changed: once per ALL YAML
  per_all_yaml_when_tf_changed:
    needs: diff
    if: needs.diff.outputs.tf_changed == 'true' && needs.diff.outputs.yaml_all_count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.yaml_all_json) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Process ALL YAML due to TF change
        id: parse
        run: |
          echo ".tf changed; processing YAML: ${{ matrix.file }}"
          account_id=$(yq '.account_id' "${{ matrix.file }}" || true)
          echo "account_id=$account_id" >> "$GITHUB_OUTPUT"
      - name: Use account_id
        run: echo "Account ID -  ${{ steps.parse.outputs.account_id }}"

name: "Terraform AWS OCR Infra Provisioning"

# Limitation: Do not delete and update YAML/.tf files simultaneously in a single commit.
run-name: Deploy to ${{ github.ref_name }} by @${{ github.actor }} - ${{inputs.incident}}

on:
  push:
    paths:
      - 'dev/**' 

permissions:
 id-token: write
 contents: read
jobs:
  diff:
    runs-on: ubuntu-latest
    outputs:
      # from build-yaml-matrix
      files_json:         ${{ steps.matrix.outputs.files_json }}
      count:              ${{ steps.matrix.outputs.count }}
      # from detect-deleted-yaml
      deleted_files_json: ${{ steps.deleted.outputs.deleted_files_json }}
      deleted_count:      ${{ steps.deleted.outputs.deleted_count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head SHAs
        id: shas
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "BASE=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.sha }}"        >> "$GITHUB_OUTPUT"
          fi

      # We will put if dev or prod condition to define folder specific changes.
      - name: List changed files
        run: |
          git diff --name-only "${{ steps.shas.outputs.BASE }}" "${{ steps.shas.outputs.HEAD }}" -- dev/ > changed.txt
          echo "Changed under dev/:"
          cat changed.txt || true

      - name: Prepare JSON for matrix (YAML to process)
        id: matrix
        uses: ./.github/actions/build-yaml-matrix
        with:
          changed_file_list: changed.txt
          path: dev # TODO, dynamic

      - name: Detect deleted YAML under dev/
        id: deleted
        uses: ./.github/actions/detect-deleted-yaml
        with:
          base: ${{ steps.shas.outputs.BASE }}
          head: ${{ steps.shas.outputs.HEAD }}
          path: dev # TODO, dynamic

  # per_changed_yaml:
  #   needs: diff
  #   if: needs.diff.outputs.count != '0' && needs.diff.outputs.deleted_count == '0'
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       file: ${{ fromJson(needs.diff.outputs.files_json) }}
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1
  #     - name: Read account_id from YAML
  #       id: parse
  #       run: |
  #         # show which file this job is working on
  #         echo "Processing file: ${{ matrix.file }}"

  #         # parse account_id (requires yq, preinstalled on ubuntu-latest)
  #         account_id=$(yq '.account_id' "${{ matrix.file }}")
  #         echo "Account ID: $account_id"

  #         # export as output (so later steps or jobs can use it)
  #         echo "account_id=$account_id" >> "$GITHUB_OUTPUT"

  #     - name: Use account_id
  #       run: |
  #         echo "This job handled file: ${{ matrix.file }}"
  #         echo "Account ID from YAML: ${{ steps.parse.outputs.account_id }}"

  per_changed_yaml:
    needs: diff
    if: needs.diff.outputs.count != '0'   # allow alongside deletions
    uses: ./.github/workflows/process-yaml.yml
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.files_json) }}
    with:
      file: ${{ matrix.file }}
      mode: changed

  per_deleted_yaml:
    needs: diff
    if: needs.diff.outputs.deleted_count != '0'
    uses: ./.github/workflows/process-yaml.yml
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.deleted_files_json) }}
    with:
      file: ${{ matrix.file }}
      mode: deleted
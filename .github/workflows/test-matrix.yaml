name: "Terraform AWS OCR Infra Provisioning"

run-name: Deploy to ${{ github.ref_name }} by @${{ github.actor }} - ${{inputs.incident}}

on:
  push:
    paths:
      - 'dev/**'

permissions:
  id-token: write
  contents: read

jobs:
  diff:
    runs-on: ubuntu-latest
    outputs:
      files_json:        ${{ steps.prepare.outputs.files_json }}
      count:             ${{ steps.prepare.outputs.count }}
      tf_changed:        ${{ steps.prepare.outputs.tf_changed }}
      yaml_all_json:     ${{ steps.prepare.outputs.yaml_all_json }}
      yaml_all_count:    ${{ steps.prepare.outputs.yaml_all_count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head SHAs
        id: shas
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "BASE=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.sha }}"        >> "$GITHUB_OUTPUT"
          fi

      # Changed files only under dev/
      - name: List changed files (dev/)
        run: |
          git diff --name-only "${{ steps.shas.outputs.BASE }}" "${{ steps.shas.outputs.HEAD }}" -- dev/ > changed.txt
          echo "Changed under dev/:"
          cat changed.txt || true

      # Detect any .tf change (repo-wide) and prepare both 'changed YAML' and 'all YAML' lists
      - name: Prepare outputs
        id: prepare
        run: |
          set -euo pipefail

          # 1) YAML changed in dev/
          files_json=$(
            grep -E '^dev/.*\.(ya?ml)$' changed.txt 2>/dev/null \
              | jq -R -s -c 'split("\n") | map(select(length>0))'
          )
          [ -z "${files_json:-}" ] && files_json='[]'
          echo "count=$(jq -r 'length' <<<"$files_json")" >> "$GITHUB_OUTPUT"
          {
            echo "files_json<<EOF"
            echo "$files_json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # 2) Detect any .tf change anywhere in repo
          git diff --name-only "${{ steps.shas.outputs.BASE }}" "${{ steps.shas.outputs.HEAD }}" > changed_repo.txt
          if grep -qE '\.tf$' changed_repo.txt; then
            echo "tf_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "tf_changed=false" >> "$GITHUB_OUTPUT"
          fi

          # 3) All YAMLs currently under dev/ (for re-run when tf_changed)
          yaml_all_json=$(
            git ls-files -- 'dev/*.yaml' 'dev/**/*.yaml' 'dev/*.yml' 'dev/**/*.yml' 2>/dev/null \
              | jq -R -s -c 'split("\n") | map(select(length>0))'
          )
          [ -z "${yaml_all_json:-}" ] && yaml_all_json='[]'
          echo "yaml_all_count=$(jq -r 'length' <<<"$yaml_all_json")" >> "$GITHUB_OUTPUT"
          {
            echo "yaml_all_json<<EOF"
            echo "$yaml_all_json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  # Run once per CHANGED YAML in dev/
  per_changed_yaml:
    needs: diff
    if: needs.diff.outputs.count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.files_json) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Read account_id from YAML
        id: parse
        run: |
          echo "Processing file: ${{ matrix.file }}"
          account_id=$(yq '.account_id' "${{ matrix.file }}")
          echo "account_id=$account_id" >> "$GITHUB_OUTPUT"
      - name: Use account_id
        run: |
          echo "This job handled file: ${{ matrix.file }}"
          echo "Account ID: ${{ steps.parse.outputs.account_id }}"

  # If ANY .tf changed, re-run for ALL YAMLs in dev/
  per_all_yaml_when_tf_changed:
    needs: diff
    if: needs.diff.outputs.tf_changed == 'true' && needs.diff.outputs.yaml_all_count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.yaml_all_json) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Read account_id from YAML (full run due to .tf change)
        id: parse
        run: |
          echo ".tf changed; processing: ${{ matrix.file }}"
          account_id=$(yq '.account_id' "${{ matrix.file }}")
          echo "account_id=$account_id" >> "$GITHUB_OUTPUT"
      - name: Use account_id
        run: |
          echo "Account ID: ${{ steps.parse.outputs.account_id }}"

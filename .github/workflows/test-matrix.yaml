name: "Terraform AWS OCR Infra Provisioning"

run-name: Deploy to ${{ github.ref_name }} by @${{ github.actor }} - ${{inputs.incident}}

on:
  push:

permissions:
 id-token: write
 contents: read
jobs:
  diff:
    runs-on: ubuntu-latest
    outputs:
      files_json: ${{ steps.prepare.outputs.files_json }}
      count: ${{ steps.prepare.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head SHAs
        id: shas
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "BASE=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "HEAD=${{ github.sha }}"        >> "$GITHUB_OUTPUT"
          fi

      - name: List changed files
        run: |
          git diff --name-only ${{ steps.shas.outputs.BASE }} ${{ steps.shas.outputs.HEAD }} > changed.txt
          cat changed.txt || true

      - name: Prepare JSON for matrix
        id: prepare
        run: |
          files=$(awk NF changed.txt | jq -R . | jq -s .)
          echo "files_json=$files" >> "$GITHUB_OUTPUT"
          echo "count=$(echo "$files" | jq length)" >> "$GITHUB_OUTPUT"

  per_file:
    needs: diff
    if: needs.diff.outputs.count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.diff.outputs.files_json) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Work on one file
        run: |
          echo "Handling file: ${{ matrix.file }}"
          # your per-file logic here
